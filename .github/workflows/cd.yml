name: CD

on:
  push:
    tags:
      - v[0-9]+.[0-9]+.*

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Install Clojure Tools
      uses: DeLaGuardo/setup-clojure@9.5
      with:
        cli: latest
    - name: Cache local Maven repository
      uses: actions/cache@v2
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/deps.edn') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    - name: Build
      id: build
      run: |
        set -x
        artifact=$(clojure -T:build uber "{:version \"${GITHUB_REF_NAME}\"}")
        echo ::set-output name=artifact::"$artifact"
    - name: Check artifact
      run: |
        set -e
        ls ${{ steps.build.outputs.artifact }}
        java -jar ${{ steps.build.outputs.artifact }} --help | grep Usage
    - name: Upload
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.build.outputs.artifact }}
